<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Referral Fee Memo ‚Äì Generator</title>
  <style>
    /* ================= THEME ================= */
    :root{
      --bg:#0f1020; --panel:#16172a; --border:#2a2c45; --ink:#e8e6ff;
      --ink-soft:#c9c4ea; --ink-muted:#a59fcc; --brand:#a78bfa; --brand-soft:#262348;
      --thead:#1b1c33; --chip-bg:#1e1f39; --num:#a78bfa; --link:#bda7ff;
      --accent:#ffa382; --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    body.light{
      --bg:#faf9ff; --panel:#ffffff; --border:#e4dcff; --ink:#2f2a44;
      --ink-soft:#4b4168; --ink-muted:#74669a; --brand:#7030A0; --brand-soft:#efeaff;
      --thead:#faf7ff; --chip-bg:#f4f3ff; --num:#4b2a7a; --link:#6a46ff;
      --accent:#ff7a59; --ok:#16a34a; --warn:#b45309; --err:#b91c1c;
    }

    /* ================= BASE ================= */
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--bg);margin:0}
    a{color:var(--link)}
    .container{max-width:920px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:16px;justify-content:space-between;align-items:center;padding:12px 0 4px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:28px;height:28px;background:var(--chip-bg);border-radius:6px}
    .brand h1{font-size:18px;margin:0;color:var(--brand)}
    .brand small{color:var(--ink-muted)}
    .theme-toggle{border:1px solid var(--border);background:transparent;color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0 18px 0}
    .panel h2{margin:0 0 12px 0;color:var(--brand);font-size:18px}
    .muted{color:var(--ink-muted)}
    .note{font-size:12px;color:var(--ink-muted);margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){ .grid,.grid-3,.grid-2{grid-template-columns:1fr} }

    label{display:block;font-size:12px;color:var(--ink-soft);margin-bottom:6px}
    select,input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--ink);font-size:14px}
    .btnrow{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{border:1px solid var(--border);background:var(--panel);color:var(--ink);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .status{display:flex;align-items:center;gap:10px;font-size:13px;margin-top:6px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ink-muted)}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    .dot.spin{border:2px solid var(--ink-muted);border-top-color:transparent;border-radius:50%;width:14px;height:14px;animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .footer{font-size:12px;text-align:center;color:var(--ink-muted);margin:24px 0 10px 0}
    code.inline{background:var(--chip-bg);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <!-- ====== TOP BAR ====== -->
    <header class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Referral Fee Memo ‚Äì Generator</h1>
          <small>Generate .docx memos from your dashboard selection</small>
        </div>
      </div>
      <button class="theme-toggle" id="themeBtn" title="Toggle theme">‚òÄÔ∏è Light</button>
    </header>

    <!-- ====== BUILDER ====== -->
    <section class="panel">
      <h2>Memo Builder</h2>
      <div class="grid-3">
        <div>
          <label>Memo Type</label>
          <select id="memoType">
            <option value="ReferralFeeMemo" selected>Referral Fee Memo</option>
          </select>
        </div>

        <div>
          <label>Month</label>
          <select id="monthSelect" title="MMM yyyy"></select>
        </div>

        <div>
          <label>Entity (optional)</label>
          <select id="entitySelect">
            <option value="">All</option>
            <option value="SAM">SAM</option>
            <option value="FIR_RAM">FIR & RAM</option>
          </select>
        </div>
      </div>

      <div class="grid-2" style="margin-top:10px">
        <div>
          <label>Minimum Reserve Price (RM)</label>
          <select id="minValue">
            <option value="10000000" selected>‚â• 10,000,000</option>
            <option value="0">Include all values</option>
          </select>
          <div class="note">Used to filter Appendix A rows (e.g., ‚ÄúBlanket Approval Above 10mil‚Äù).</div>
        </div>
        <div>
          <label>Output File Name (auto)</label>
          <input id="fileNamePreview" type="text" value="Referral_Fee_Memo_yyyy-MM.docx" readonly/>
          <div class="note">Will update when you change Month.</div>
        </div>
      </div>

      <div class="btnrow">
        <button id="testBtn" class="btn" title="Dry run without downloading">üîé Test</button>
        <button id="genBtn" class="btn primary" title="Generate and download Word memo">‚¨áÔ∏è Generate Word</button>
      </div>

      <div id="status" class="status">
        <div class="dot"></div>
        <div id="statusText" class="muted">Awaiting input‚Ä¶</div>
      </div>
    </section>

    <!-- ====== HELP ====== -->
    <section class="panel">
      <h2>How this works</h2>
      <ol class="muted">
        <li>Pick the <strong>Month</strong>. The page sends <code class="inline">{"memoType","memoMonth","entity","minValueRM"}</code> to your Power Automate HTTP flow.</li>
        <li>The flow uses the <em>Word Online (Business)</em> action <em>Populate a Microsoft Word template</em> to fill your template‚Äôs <strong>Content Controls</strong> (and a <strong>Repeating Section</strong> for Appendix A), then returns the .docx to the browser. [1](https://www.youtube.com/watch?v=vpo_U5Qf1ak)</li>
        <li>Insert Content Controls via Word‚Äôs <em>Developer</em> tab and give them unique titles; Rich Text / Date Picker aren‚Äôt supported by this connector. [1](https://www.youtube.com/watch?v=vpo_U5Qf1ak)[2](https://www.thewindowsclub.com/dd-and-change-content-controls-in-word)</li>
      </ol>
      <div class="note">Make sure your flow response sets <code class="inline">Access-Control-Allow-Origin: *</code> so this page can download the file directly.</div>
    </section>

    <footer class="footer">Built for Izazi ‚Ä¢ Dark‚Äëmode friendly</footer>
  </div>

  <script>
    /* ======= 1) CONFIG: paste your Flow URL here ======= */
    // Power Automate trigger: "When an HTTP request is received" ‚Üí copy the POST URL
    const FLOW_URL = "PASTE_YOUR_FLOW_URL_HERE";

    /* ======= 2) THEME (default: dark for low-distraction) ======= */
    (function initTheme(){
      const saved = localStorage.getItem("memo_theme");
      if(saved === "light") document.body.classList.add("light");
      const btn = document.getElementById("themeBtn");
      function update(){
        const light = document.body.classList.contains("light");
        btn.textContent = light ? "üåô Dark" : "‚òÄÔ∏è Light";
        btn.title = light ? "Switch to Dark Mode" : "Switch to Light Mode";
      }
      btn.addEventListener("click", ()=>{
        document.body.classList.toggle("light");
        localStorage.setItem("memo_theme", document.body.classList.contains("light") ? "light" : "dark");
        update();
      });
      update();
    })();

    /* ======= 3) UI HELPERS ======= */
    const $ = (id) => document.getElementById(id);
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatFileName(monthKey){
      return `Referral_Fee_Memo_${monthKey}.docx`;
    }
    function setStatus(kind, text){
      const dot = document.querySelector(".status .dot");
      dot.className = "dot"; // reset
      if(kind === "idle") { /* default */ }
      if(kind === "spin") dot.classList.add("spin");
      if(kind === "ok") dot.classList.add("ok");
      if(kind === "warn") dot.classList.add("warn");
      if(kind === "err") dot.classList.add("err");
      $("statusText").textContent = text;
    }
    function monthsBackList(n=18){
      const list = [];
      const today = new Date();
      const start = new Date(today.getFullYear(), today.getMonth(), 1);
      for(let i=0;i<n;i++){
        const d = new Date(start);
        d.setMonth(d.getMonth() - i);
        const key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; // yyyy-MM
        const label = d.toLocaleDateString("en-MY",{month:"short", year:"numeric"});
        list.push({key, label});
      }
      return list;
    }

    /* ======= 4) INIT DROPDOWNS ======= */
    (function init(){
      // Month dropdown (last 18 months, newest first)
      const dd = $("monthSelect");
      monthsBackList(18).forEach(m=>{
        const opt = new Option(m.label, m.key);
        dd.add(opt);
      });
      $("fileNamePreview").value = formatFileName(dd.value);

      dd.addEventListener("change", ()=>{
        $("fileNamePreview").value = formatFileName(dd.value);
      });
    })();

    /* ======= 5) DOWNLOAD HELPER ======= */
    function downloadBlob(blob, fileName){
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      URL.revokeObjectURL(link.href);
      link.remove();
    }

    /* ======= 6) CORE: call flow & download ======= */
    async function callFlow(action){
      if(!FLOW_URL || FLOW_URL.startsWith("PASTE_")){
        setStatus("warn","Please paste your Power Automate FLOW_URL at the top of this file.");
        alert("FLOW_URL is not set. Edit the file and paste your Flow HTTP POST URL.");
        return null;
      }
      const memoType = $("memoType").value;
      const memoMonth = $("monthSelect").value; // yyyy-MM
      const entity    = $("entitySelect").value; // optional
      const minValueRM = Number($("minValue").value);

      const payload = { memoType, memoMonth, entity, minValueRM };
      const headers = { "Content-Type":"application/json" };

      setStatus("spin","Generating memo‚Ä¶");
      $("genBtn").disabled = true; $("testBtn").disabled = true;
      try{
        const res = await fetch(FLOW_URL, { method:"POST", headers, body: JSON.stringify(payload) });
        const ctype = res.headers.get("Content-Type") || "";
        if(!res.ok){
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text || "Flow returned an error"}`);
        }

        // If flow returns binary .docx directly
        if(ctype.includes("application/vnd.openxmlformats-officedocument.wordprocessingml.document")){
          const blob = await res.blob();
          if(action === "download"){
            downloadBlob(blob, $("fileNamePreview").value);
            setStatus("ok","Memo generated and downloaded.");
          }else{
            setStatus("ok",`Memo generated (${(blob.size/1024).toFixed(1)} KB).`);
          }
          return true;
        }

        // If flow returns JSON { fileUrl: "..." } fall back to link
        if(ctype.includes("application/json")){
          const data = await res.json();
          if(data.fileUrl){
            if(action === "download"){
              // Navigate to file URL (SharePoint/OneDrive)
              window.location.href = data.fileUrl;
            }
            setStatus("ok","Memo ready at returned file URL.");
            return true;
          }
        }

        // Unknown content
        setStatus("warn","Flow responded, but format wasn‚Äôt recognized. Check flow response headers.");
        return false;
      }catch(err){
        console.error(err);
        setStatus("err", err.message);
        alert("Failed to generate memo:\n" + err.message);
        return false;
      }finally{
        $("genBtn").disabled = false; $("testBtn").disabled = false;
      }
    }

    // Buttons
    $("genBtn").addEventListener("click", ()=>callFlow("download"));
    $("testBtn").addEventListener("click", ()=>callFlow("test"));
  </script>
</body>
</html>
``