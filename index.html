
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PSC Dashboard â€“ Overview</title>
  <style>
    /* ================= THEME ================= */
    :root{
      --bg:#faf9ff; --panel:#ffffff; --border:#e4dcff; --ink:#2f2a44;
      --ink-soft:#6b5f87; --ink-muted:#8c7ba8; --brand:#7030A0; --brand-soft:#efeaff;
      --thead:#faf7ff; --chip-bg:#f4f3ff;
      --num:#4b2a7a; --link:#6a46ff;

      --chart-rf:#6a46ff; --chart-sam:#9b78ff; --chart-all:#c9b6e4;
      --hbar-track:#f1edff; --hbar-fill:#9b78ff;
      --green:#16a34a; --red:#dc2626;

      --accent:#ff7a59; --accent-soft:rgba(255,122,89,.12);
      --tri-green:#2e7d32; --tri-green-dark:#1b5e20;
    }
    body.dark{
      --bg:#0f1020; --panel:#16172a; --border:#2a2c45; --ink:#e8e6ff;
      --ink-soft:#c9c4ea; --ink-muted:#a59fcc; --brand:#a78bfa; --brand-soft:#262348;
      --thead:#1b1c33; --chip-bg:#1e1f39;
      --num:#a78bfa; --link:#bda7ff;

      --chart-rf:#8b78ff; --chart-sam:#b8a5ff; --chart-all:#8b93b9;
      --hbar-track:#252747; --hbar-fill:#b8a5ff;

      --accent:#ffa382; --tri-green:#43a047; --tri-green-dark:#2e7d32;
    }

    /* ================= BASE ================= */
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;color:var(--ink);background:var(--bg);margin:0}
    .topbar{display:flex;gap:16px;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:28px;height:28px;background:var(--chip-bg);border-radius:6px}
    .brand h1{font-size:16px;margin:0;color:var(--brand)}
    .brand small{color:var(--ink-muted)}
    .tabs a{margin:0 6px;text-decoration:none;color:var(--ink-soft);padding:6px 10px;border-radius:8px}
    .tabs a.active{background:var(--brand-soft);color:var(--brand)}
    .theme-toggle{border:1px solid var(--border);background:transparent;color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer}

    main{max-width:1200px;margin:18px auto;padding:0 16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:24px}
    .panel h2{margin:0 0 12px 0;color:var(--brand);font-size:18px}
    .section-title{margin-top:26px}
    .site-footer{max-width:1200px;margin:0 auto 24px auto;color:var(--ink-muted);text-align:center;font-size:12px}

    /* ================= FILTERS ================= */
    .filter-bar{display:flex;gap:16px;align-items:flex-end;margin-bottom:18px;flex-wrap:wrap}
    .filter-bar label{font-size:12px;color:var(--ink-soft)}
    .filter-bar select,.filter-bar button{padding:6px 10px;font-size:13px;border:1px solid var(--border);border-radius:8px;background:var(--panel);color:var(--ink)}
    .filter-bar button{background:var(--brand);color:#fff;border-color:var(--brand);cursor:pointer}
    .filter-bar button:disabled{opacity:.6;cursor:not-allowed}

    /* ================= SECTION 1 (KPIs) ================= */
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;justify-content:center;min-height:110px}
    .kpi h3{margin:0 0 6px 0;font-size:12px;color:var(--ink-soft);text-align:center}
    .kpi .value{font-size:24px;font-weight:800;color:var(--brand);cursor:pointer;text-align:center}
    .kpi .value:hover{text-decoration:underline}
    .kpi .yoy{font-size:11px;margin-top:6px;font-weight:600;text-align:center}
    .kpi.sold .value{font-size:34px;line-height:1;color:var(--num)}
    .kpi.sold{align-items:center;gap:6px}

    /* ================= SECTION 2 (YTD) ================= */
    .ytd-grid{display:grid;grid-template-columns:65% 35%;gap:20px}
    .ytd-table{width:100%;border-collapse:collapse;font-size:15px;color:var(--ink)}
    .ytd-table th,.ytd-table td{padding:14px;text-align:center;border-bottom:1px solid var(--border)}
    .ytd-table thead th{background:var(--thead);color:var(--ink-soft)}
    .ytd-header{text-decoration:underline;font-weight:800}
    .ytd-sep{border-left:2px solid var(--border)}
    .ytd-overall{background:rgba(127,127,255,0.06);font-weight:900}
    .ytd-yoy{font-size:11px;margin-top:6px;font-weight:700}
    .ytd-click{cursor:pointer}
    .ytd-click:hover{background:var(--brand-soft)}
    .chart{height:260px;display:flex;align-items:flex-end;gap:20px}
    .year-group{flex:1;display:flex;flex-direction:column;align-items:center}
    .bar-set{display:flex;gap:8px;align-items:flex-end;height:220px}
    .bar{width:20px;border-radius:6px 6px 0 0;display:block;text-decoration:none}
    .bar.rf{background:var(--chart-rf)}
    .bar.sam{background:var(--chart-sam)}
    .bar.all{background:var(--chart-all)}

    /* ================= SECTION 3 (Publication) ================= */
    .card-row{display:grid;grid-template-columns:300px 1fr;gap:16px;align-items:stretch}
    .right-group{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:stretch}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column}
    .card.centered{justify-content:center;align-items:center;text-align:center}
    .card h3{margin:0 0 8px 0;font-size:12px;color:var(--ink-soft)}
    .big{font-size:32px;line-height:1;font-weight:900;color:var(--num);cursor:pointer}
    .big:hover{text-decoration:underline}
    .sub{font-size:12px;color:var(--ink-muted);margin-top:6px}
    .auction-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
    .auction-item{background:var(--chip-bg);border-radius:10px;padding:10px;text-align:center;display:flex;flex-direction:column;gap:6px;flex:1}
    .auction-item .num{font-size:22px;line-height:1;font-weight:900;color:var(--num)}
    .channel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .channel-col{background:var(--chip-bg);border-radius:10px;padding:10px;text-align:center}
    .channel-col .qty{font-size:20px;line-height:1;font-weight:900;color:var(--num);cursor:pointer}
    .channel-col .val{font-size:11px;color:var(--ink-muted)}

    .row2{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .small-table{width:100%;border-collapse:collapse;font-size:11px}
    .small-table th,.small-table td{padding:6px;border:1px solid var(--border)}
    .small-table th{background:var(--thead);color:var(--ink-soft)}
    .small-table tfoot td{font-weight:700;background:var(--brand-soft)}
    .small-table tr.clickable{cursor:pointer}
    .small-table tr.clickable:hover{background:var(--brand-soft)}

    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .hbar{display:grid;gap:6px}
    .hbar-row{display:grid;grid-template-columns:110px 1fr 50px;align-items:center;gap:8px;position:relative;text-decoration:none;color:inherit}
    .hbar-track{background:var(--hbar-track);border-radius:6px;height:14px;overflow:hidden}
    .hbar-fill{height:100%;background:var(--hbar-fill);border-radius:6px}
    .hbar-label{font-size:11px;color:var(--ink-soft)}
    .hbar-pct{font-size:11px;font-weight:800;text-align:right;color:var(--num)}
    .hbar-row .tooltip{
      position:absolute;left:110px;top:-6px;background:#2e1065;color:#fff;font-size:11px;
      padding:6px 8px;border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;
      transform:translateY(-4px);transition:0.15s;z-index:10
    }
    .hbar-row:hover .tooltip{opacity:1;transform:translateY(0)}

    .toggle-wrap{display:flex;gap:10px;align-items:center;margin:8px 0 0 0}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .seg button{border:0;background:transparent;color:var(--ink);padding:6px 12px;cursor:pointer;font-size:12px}
    .seg button.active{background:var(--brand-soft);color:var(--brand)}

    /* ================= SECTION 4 (Referral) ================= */
    .grid-2{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .kpi-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
    .kpi-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;min-height:90px}
    .kpi-card .label{font-size:12px;color:var(--ink-soft)}
    .kpi-card .num{font-size:22px;font-weight:900;color:var(--num); cursor:pointer}
    .kpi-card .num:hover{text-decoration:underline}

    .mini{font-size:11px;color:var(--ink-muted)}
    .ref-hbar{display:grid;gap:6px}
    .ref-row{display:grid;grid-template-columns:130px 1fr 60px;align-items:center;gap:8px;position:relative;text-decoration:none;color:inherit}
    .ref-track{background:var(--hbar-track);border-radius:6px;height:12px;overflow:hidden}
    .ref-fill{height:100%;background:var(--hbar-fill);border-radius:6px}
    .ref-pct{text-align:right;font-weight:800;color:var(--num);font-size:11px}
    .ref-row .tooltip{
      position:absolute;left:130px;top:-6px;background:#2e1065;color:#fff;font-size:11px;
      padding:6px 8px;border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;
      transform:translateY(-4px);transition:0.15s;z-index:10; max-width:520px; white-space:normal;
    }
    .ref-row:hover .tooltip{opacity:1;transform:translateY(0)}

    .pill{display:inline-block;background:var(--chip-bg);padding:2px 8px;border-radius:999px;font-size:11px;margin-left:8px}
    .link{color:var(--link);text-decoration:underline;cursor:pointer}
    body.dark .link{color:var(--link)}

    .top-agent{display:flex;justify-content:space-between;align-items:center;gap:12px;min-height:78px}
    .top-agent .left{display:flex;flex-direction:column;gap:4px}
    .top-agent .agent-name{font-size:20px;font-weight:900;color:var(--num); cursor:pointer}
    .top-agent .agent-name:hover{text-decoration:underline}
    .top-agent .year-seg{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .top-agent .year-seg button{border:0;background:transparent;color:var(--ink);padding:6px 12px;cursor:pointer;font-size:12px}
    .top-agent .year-seg button.active{background:var(--brand-soft);color:var(--brand)}
    .top-agent .qty{font-size:22px;font-weight:900;color:var(--num); cursor:pointer}
    .top-agent .qty-wrap{display:flex;align-items:center;gap:8px}
    .top-agent .qty-label{font-size:12px;color:var(--ink-soft)}

    .ref-ytd-controls{ margin-top:8px; margin-bottom:18px; }
    .ref-summ-row{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-top:34px; }
    .ref-summ{
      position:relative; background:var(--panel); border:1px solid var(--border); border-radius:18px;
      padding:22px 16px 16px;
      box-shadow:0 10px 24px rgba(112,48,160,0.08);
      display:flex; flex-direction:column; gap:8px; min-height:170px; overflow:visible;
    }
    .ref-summ::before{
      content:""; position:absolute; top:-10px; left:50%; transform:translateX(-50%);
      width:0; height:0; border-left:18px solid transparent; border-right:18px solid transparent;
      border-bottom:18px solid var(--tri-green);
      filter:drop-shadow(0 4px 6px rgba(0,0,0,.18));
    }
    .ref-summ .badge-year{
      position:absolute; left:50%; top:-26px; transform:translateX(-50%);
      background:linear-gradient(180deg,var(--tri-green),var(--tri-green-dark));
      color:#fff; font-size:11px; font-weight:800; padding:4px 10px; border-radius:10px;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .ref-summ .primary{ font-size:26px; line-height:1; font-weight:900; color:var(--num); }
    .ref-summ .accent{ color:var(--accent); font-weight:900; }
    .ref-summ .muted{ font-size:12px; color:var(--ink-soft); }
    .ref-summ .note{ font-size:11px; color:var(--ink-muted); }
    .ref-summ hr{ border:0; border-top:1px solid var(--border); margin:8px 0; }

    /* Make links inside Referral Summary cards clean & non-underlined */
    .ref-summ a { text-decoration:none; color:inherit; }
    .ref-summ a.block { display:block; border-radius:10px; padding:6px 8px; }
    .ref-summ a.block:hover { background:var(--brand-soft); }

    @media (max-width:1000px){
      .kpi-grid{grid-template-columns:repeat(2,1fr)}
      .ytd-grid{grid-template-columns:1fr}
      .card-row{grid-template-columns:1fr}
      .right-group{grid-template-columns:1fr}
      .row2,.row3{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .kpi-row{grid-template-columns:repeat(2,1fr)}
      .ref-summ-row{grid-template-columns:1fr;}
    }

    /* ===== Upcoming auctions: notice bar + modal ===== */
    .notice { display:flex; align-items:center; gap:10px; background:var(--brand-soft);
      border:1px solid var(--border); color:var(--ink); border-radius:10px; padding:10px 12px; margin:10px 0 14px 0; }
    .notice .dot { width:8px; height:8px; border-radius:50%; background:var(--brand);
      box-shadow:0 0 0 3px rgba(112,48,160,.10); }
    .notice .muted { color:var(--ink-soft); font-size:12px; }
    .notice a { color:var(--link); text-decoration:underline; }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ width:min(820px, 92vw); max-height:80vh; overflow:auto; background:var(--panel); color:var(--ink);
      border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); }
    .modal h3{ margin:0 0 10px 0; font-size:14px; color:var(--ink-soft); }
    .modal .close{ float:right; border:1px solid var(--border); background:transparent;
      border-radius:8px; padding:6px 10px; cursor:pointer; color:var(--ink); }
    .modal .small-table{ font-size:12px; }
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <div class="logo"></div>
    <div>
      <h1>PSC Dashboard</h1>
      <small>Overview</small>
    </div>
  </div>
  <nav class="tabs">
    <a href="index.html" class="active">Dashboard</a>
    <a href="assets.html">Assets</a>
    <a href="agents.html">Agents</a>
    <a href="search.html">Search</a>
    <a href="report.html">Report</a>
    <a href="help.html">Help</a>
  </nav>
  <button class="theme-toggle" id="themeBtn" title="Toggle theme">ðŸŒ™ Dark</button>
</header>

<main>

  <!-- =============== SECTION 1 =============== -->
  <section class="panel">
    <h2>Sales Performance</h2>
    <div class="filter-bar">
      <div>
        <label>Entity</label><br>
        <select id="entityFilter">
          <option value="">All</option>
          <option value="FIR_RAM">FIR & RAM</option>
          <option value="SAM">SAM</option>
        </select>
      </div>
      <div>
        <label>Period</label><br>
        <select id="periodType">
          <option value="">- Select Period -</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
      <div id="monthWrap" style="display:none">
        <label>Month</label><br>
        <select id="monthSelect"></select>
      </div>
      <div id="yearWrap" style="display:none">
        <label>Year</label><br>
        <select id="yearSelect"></select>
      </div>
      <button id="applyBtn" onclick="applySales()" disabled>Apply</button>
    </div>

    <div class="kpi-grid">
      <div class="kpi sold">
        <h3>Assets Sold</h3>
        <div class="value" id="kCount" onclick="goSales()">0</div>
      </div>
      <div class="kpi">
        <h3>Sold Value</h3>
        <div class="value" id="kValue" onclick="goSales()">RM 0.00</div>
      </div>
      <div class="kpi">
        <h3>Comparison (Count)</h3>
        <div class="value" id="kCompC">â€“</div>
        <div class="yoy" id="kYoYC"></div>
      </div>
      <div class="kpi">
        <h3>Comparison (Value)</h3>
        <div class="value" id="kCompV">â€“</div>
        <div class="yoy" id="kYoYV"></div>
      </div>
    </div>
  </section>

  <!-- =============== SECTION 2 =============== -->
  <section class="panel">
    <h2>YTD Sales Performance</h2>
    <div class="filter-bar">
      <div>
        <label>Cutoff Month</label><br>
        <select id="ytdMonth"></select>
      </div>
      <div>
        <label>Base Year</label><br>
        <select id="ytdYear"></select>
      </div>
      <button onclick="renderYTD()">Apply</button>
    </div>

    <div class="ytd-grid">
      <table class="ytd-table">
        <thead>
          <tr>
            <th>Entity</th>
            <th colspan="2" id="yh0" class="ytd-header">XX</th>
            <th colspan="2" id="yh1" class="ytd-header ytd-sep">XX</th>
            <th colspan="2" id="yh2" class="ytd-header ytd-sep">XX</th>
          </tr>
          <tr>
            <th></th>
            <th>Value</th><th>Qty</th>
            <th class="ytd-sep">Value</th><th>Qty</th>
            <th class="ytd-sep">Value</th><th>Qty</th>
          </tr>
        </thead>
        <tbody id="ytdBody"></tbody>
      </table>
      <div class="chart" id="ytdChart"></div>
    </div>
  </section>

  <!-- =============== SECTION 3 =============== -->
  <section class="panel">
    <h2>Publication Performance</h2>

    <div id="upNotice" class="notice" style="display:none">
      <span class="dot"></span>
      <div>
        <div><strong><span id="upCount">0</span> upcoming auction<span id="upPlural">s</span></strong></div>
        <div class="muted">
          Nearest: <span id="upNearest">â€“</span> â€¢ <a href="#" id="upDetails">View details</a>
        </div>
      </div>
    </div>

    <div class="card-row">
      <div class="card centered" style="min-height:140px">
        <h3>Total Published Assets</h3>
        <div class="big" id="pubCount" onclick="goPublishedAll()">0</div>
        <div class="sub" id="pubValue">RM 0.00</div>
      </div>
      <div class="right-group">
        <div class="card" style="min-height:140px">
          <h3>Public Auction Readiness</h3>
          <div class="auction-grid">
            <div class="auction-item">
              <div>With Auction Date</div>
              <div class="num" id="withAuction" onclick="goAuction('with')">0</div>
            </div>
            <div class="auction-item">
              <div>Without Auction Date</div>
              <div class="num" id="withoutAuction" onclick="goAuction('without')">0</div>
            </div>
          </div>
        </div>
        <div class="card" style="min-height:140px">
          <h3>Mode of Disposal (Channel)</h3>
          <div class="channel-grid">
            <div class="channel-col">
              <div>Public Auction</div>
              <div class="qty" id="chAuction" onclick="goChannel('PUBLIC AUCTION')">0</div>
              <div class="val" id="chAuctionVal">RM 0.00</div>
            </div>
            <div class="channel-col">
              <div>Private Treaty</div>
              <div class="qty" id="chPrivate" onclick="goChannel('PRIVATE TREATY')">0</div>
              <div class="val" id="chPrivateVal">RM 0.00</div>
            </div>
            <div class="channel-col">
              <div>Open Tender</div>
              <div class="qty" id="chTender" onclick="goChannel('OPEN TENDER')">0</div>
              <div class="val" id="chTenderVal">RM 0.00</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h2 class="section-title">Category Breakdown (Published)</h2>
    <div class="row2" id="categoryTables"></div>

    <h2 class="section-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>Distribution Overview (Published)</span>
      <span class="toggle-wrap">
        <span style="font-size:12px;color:var(--ink-soft)">Bar based on:</span>
        <span class="seg">
          <button id="basisQty" class="active" onclick="setHBarBasis('qty')">Qty</button>
          <button id="basisVal" onclick="setHBarBasis('val')">Value</button>
        </span>
      </span>
    </h2>
    <div class="row3">
      <div class="card"><h3>Asset Tenure</h3><div id="tenureChart" class="hbar"></div></div>
      <div class="card"><h3>Asset Category</h3><div id="categoryChart" class="hbar"></div></div>
      <div class="card"><h3>State</h3><div id="stateChart" class="hbar"></div></div>
    </div>
  </section>

  <!-- =============== SECTION 4 (Referral) =============== -->
  <section class="panel">
    <h2>Referral Performance</h2>

    <div class="card top-agent" style="margin-bottom:12px">
      <div class="left">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0;font-size:12px;color:var(--ink-soft)">Top Referring Agent</h3>
          <div class="year-seg" id="topYearBtns"></div>
        </div>
        <div class="agent-name" id="topAgentName" title="See assets">â€“</div>
        <div class="mini" id="topAgentTotalVal" style="margin-top:2px"></div>
      </div>
      <div class="qty-wrap" title="See assets">
        <div class="qty-label">Qty</div>
        <div class="qty" id="topAgentQty">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <div>
        <label>Year</label><br>
        <select id="refYear"></select>
      </div>
      <div>
        <label>Entity</label><br>
        <select id="refEntity">
          <option value="">All</option>
          <option value="FIR,RAM">FIR &amp; RAM</option>
          <option value="SAM">SAM</option>
        </select>
      </div>
      <button onclick="renderReferral()">Apply</button>
    </div>

    <div class="grid-2">
      <div>
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="label">Total Referral Fees</div>
            <div class="num" id="refTotalFees" title="Open list">RM 0.00</div>
            <div class="mini" id="refTotalFeesNote"></div>
          </div>
          <div class="kpi-card">
            <div class="label">Referred Assets</div>
            <div class="num" id="refAssetsCount" title="Open list">0</div>
            <div class="mini" id="refAssetsNote"></div>
          </div>
          <div class="kpi-card">
            <div class="label">Avg Referral %</div>
            <div class="num" id="refAvgPct" title="Open list">0.00%</div>
            <div class="mini">based on Sale Price</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Payment Status Distribution</h3>
          <div id="refStatusBars" class="ref-hbar"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Top Agents by Referral Fees</h3>
          <div id="refTopAgents" class="ref-hbar"></div>
        </div>
      </div>

      <div class="card top5">
        <h3>Top 5 Agents by Most Assets Sold <span class="pill" id="top5Count">0</span></h3>
        <div style="overflow:auto;max-height:420px;border:1px solid var(--border);border-radius:10px">
          <table class="ref-table small-table" style="width:100%;border-collapse:separate;border-spacing:0;font-size:13px">
            <thead>
              <tr>
                <th>Agent</th>
                <th>Qty</th>
                <th>Total Value</th>
              </tr>
            </thead>
            <tbody id="top5Body">
              <tr><td colspan="3">Loadingâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <h3 class="section-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>Referral Summary (Year on Year)</span>
    </h3>

    <div class="filter-bar ref-ytd-controls">
      <div>
        <label>Cutoff Month</label><br>
        <select id="refCutoffMonth"></select>
      </div>
      <div>
        <label>Base Year</label><br>
        <select id="refBaseYear"></select>
      </div>
      <button onclick="renderRefSummaryCards()">Apply</button>
    </div>

    <div id="refSummaryRow" class="ref-summ-row"></div>
  </section>

</main>

<footer class="site-footer">Fully made by Izazi</footer>

<!-- Modal: Upcoming auctions (next 30 days) -->
<div id="upcomingModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal">
    <button class="close" id="upClose">Close</button>
    <h3>Auctions in Next 30 Days</h3>
    <div style="overflow:auto;max-height:60vh;border:1px solid var(--border);border-radius:10px">
      <table class="small-table" style="width:100%">
        <thead>
          <tr>
            <th style="width:120px">Date</th>
            <th>Asset</th>
            <th style="width:110px">State</th>
            <th style="width:130px;text-align:right">Est MV</th>
          </tr>
        </thead>
        <tbody id="upcomingList">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  /* ============== THEME ============== */
  (function initTheme(){
    const saved = localStorage.getItem("psc_theme") || "light";
    if(saved === "dark") document.body.classList.add("dark");
    const btn = document.getElementById("themeBtn");
    const update = () => {
      const dark = document.body.classList.contains("dark");
      btn.textContent = dark ? "â˜€ï¸ Light" : "ðŸŒ™ Dark";
      btn.title = dark ? "Switch to Light Mode" : "Switch to Dark Mode";
    };
    btn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("psc_theme", document.body.classList.contains("dark") ? "dark" : "light");
      update();
    });
    update();
  })();

  /* ============== HELPERS ============== */
  const assets = JSON.parse(localStorage.getItem("psc_assets") || "[]");
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const now = new Date();
  let hbarBasis = localStorage.getItem("psc_hbar_basis") || "qty";
  const $ = id => document.getElementById(id);

  function parseDate(s){
    if(!s) return null;
    const str = String(s).trim();
    if(str.includes("/")){
      const [d,m,y] = str.split("/");
      const dt = new Date(+y, +m-1, +d);
      return isNaN(dt.getTime()) ? null : dt;
    }
    const dt = new Date(str);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function monthKey(d){ const x = parseDate(d); return x ? x.toISOString().slice(0,7) : ""; }
  function yearOf(d){ const x = parseDate(d); return x ? x.getFullYear() : null; }
  function sumSale(list){ return list.reduce((t,a)=> t + (+a.SalePrice || 0), 0); }
  function money(n){ return "RM " + Number(n||0).toLocaleString("en-MY",{minimumFractionDigits:2, maximumFractionDigits:2}); }
  function moneyMil(n){ return "RM " + ((n||0)/1e6).toFixed(1) + " Mil"; }
  function yoy(curr,prev){
    if(!prev) return "";
    const v = ((curr - prev) / prev) * 100;
    return `<span style="color:${v>=0?'var(--green)':'var(--red)'}">${v>=0?'â–²':'â–¼'} ${Math.abs(v).toFixed(1)}%</span>`;
  }
  function normChannel(c){
    c = String(c||"").toUpperCase();
    if(c.includes("PUBLIC AUCTION")) return "PUBLIC AUCTION";
    if(c.includes("PRIVATE")) return "PRIVATE TREATY";
    if(c.includes("TENDER")) return "OPEN TENDER";
    return c;
  }
  function normEntity(s){
    const u = String(s||"").toUpperCase().replace(/\s+/g," ").trim();
    if(u.includes("SAM")) return "SAM";
    if(u.includes("FIR")) return "FIR";
    if(u.includes("RAM")) return "RAM";
    if(u.includes("BANK")) return "BANKING";
    return u || "N/A";
  }
  function isSold(a){ return String(a.Status||"").toUpperCase().trim() === "SOLD"; }

  /* ===== Referral helpers ===== */
  function isNoRefFeeStatus(s){ return String(s||"").toUpperCase().includes("NO REFERRAL FEE"); }
  function rateToPercent(raw){ const r = +raw || 0; return r <= 1 ? r*100 : r; } // 0.0125 -> 1.25
  function eligibleReferral(a){
    return isSold(a) && (+a.SalePrice||0) > 0 && rateToPercent(a.ReferralFeeRatePct) > 0 && !isNoRefFeeStatus(a.PaymentStatus);
  }
  function feeOf(a){
    const explicit = +a.ReferralFeeAmount || 0;
    if (explicit > 0) return explicit;
    return (+a.SalePrice||0) * (rateToPercent(a.ReferralFeeRatePct)/100);
  }
  function assetsHref(obj){ return "assets.html?" + new URLSearchParams(obj).toString(); }

  /* ===================== SECTION 1 (KPIs) ===================== */
  function applySales(){
    const entSel = $("entityFilter").value;
    const inEntity = a => {
      if(!entSel) return true;
      const e = normEntity(a.Entity);
      if(entSel === "FIR_RAM") return e==="FIR" || e==="RAM";
      if(entSel === "SAM")     return e==="SAM";
      return true;
    };

    const soldBase = assets.filter(isSold).filter(inEntity);
    let main = [], compare = [];
    if ($("periodType").value === "monthly"){
      const key = `${$("yearSelect").value}-${$("monthSelect").value}`;
      main = soldBase.filter(a => monthKey(a.SoldDate) === key);
      const d = new Date(key + "-01"); d.setMonth(d.getMonth() - 1);
      compare = soldBase.filter(a => monthKey(a.SoldDate) === d.toISOString().slice(0,7));
    }
    if ($("periodType").value === "yearly"){
      const y = +$("yearSelect").value;
      main = soldBase.filter(a => yearOf(a.SoldDate) === y);
      compare = soldBase.filter(a => yearOf(a.SoldDate) === y - 1);
    }
    $("kCount").textContent = main.length;
    $("kValue").textContent = money(sumSale(main));
    $("kCompC").textContent = compare.length ? (main.length - compare.length) : "â€“";
    $("kCompV").textContent = compare.length ? money(sumSale(main) - sumSale(compare)) : "â€“";
    $("kYoYC").innerHTML = compare.length ? yoy(main.length, compare.length) : "";
    $("kYoYV").innerHTML = compare.length ? yoy(sumSale(main), sumSale(compare)) : "";
  }
  function goSales(){
    if(!$("periodType").value){ alert("Please select Period first"); return; }
    const p = new URLSearchParams({ status: "SOLD", year: $("yearSelect").value });
    if ($("periodType").value === "monthly") { p.set("month", $("monthSelect").value); p.set("agg","month"); p.set("mode","exact"); }
    else if ($("periodType").value === "yearly") { p.set("agg","year"); }
    const ent = $("entityFilter").value;
    if (ent === "FIR_RAM") p.set("entity","FIR,RAM");
    if (ent === "SAM")     p.set("entity","SAM");
    location.href = "assets.html?" + p.toString();
  }

  /* ===================== SECTION 2 (YTD) ===================== */
  months.forEach((m,i)=>{ $("ytdMonth").add(new Option(m, String(i+1).padStart(2,"0"))); });
  const yearList = [...new Set(assets.map(a => yearOf(a.SoldDate)).filter(Boolean))].sort((a,b)=> b-a);
  if (yearList.length === 0) yearList.push(now.getFullYear());
  yearList.forEach(y=>{ $("ytdYear").add(new Option(y, y)); });
  $("ytdMonth").value = String(now.getMonth()+1).padStart(2,"0");
  $("ytdYear").value = yearList[0];

  months.forEach((m,i)=>{ const el=$("monthSelect"); if(el) el.add(new Option(m, String(i+1).padStart(2,"0"))); });
  if($("monthSelect")) $("monthSelect").value = String(now.getMonth()+1).padStart(2,"0");
  if($("yearSelect"))  yearList.forEach(y=> $("yearSelect").add(new Option(y, y)));
  if($("yearSelect"))  $("yearSelect").value = yearList[0];
  $("periodType").onchange = () => {
    const p = $("periodType").value;
    $("monthWrap").style.display = p ? "block" : "none";
    $("yearWrap").style.display  = p ? "block" : "none";
    if ($("monthSelect")) $("monthSelect").disabled = (p === "yearly");
    $("applyBtn").disabled = !p;
  };

  function renderYTD(){
    const c = +$("ytdMonth").value, b = +$("ytdYear").value; if(!c || !b) return;
    const yrs = [b, b-1, b-2];
    [$("yh0"),$("yh1"),$("yh2")].forEach((h,i)=> h.textContent = `YTD ${months[c-1]} ${yrs[i]}`);

    const rows = { RF:{}, SAM:{}, ALL:{} };
    yrs.forEach(y=>{ rows.RF[y]={v:0,q:0}; rows.SAM[y]={v:0,q:0}; rows.ALL[y]={v:0,q:0}; });

    assets.filter(isSold).forEach(a=>{
      const d = parseDate(a.SoldDate);
      if(!d || (d.getMonth()+1) > c || !yrs.includes(d.getFullYear())) return;
      const y = d.getFullYear();
      const v = +a.SalePrice || 0;
      const e = normEntity(a.Entity);
      rows.ALL[y].v += v; rows.ALL[y].q++;
      if(e === "SAM"){ rows.SAM[y].v += v; rows.SAM[y].q++; }
      if(e === "RAM" || e === "FIR"){ rows.RF[y].v += v; rows.RF[y].q++; }
    });

    // Build YTD assets URLs
    const ytdUrl = (entityKey, year) => {
      const p = new URLSearchParams({ status:"SOLD", year:String(year), month:String($("ytdMonth").value) });
      if(entityKey === "RF") p.set("entity","FIR,RAM");
      if(entityKey === "SAM") p.set("entity","SAM");
      return "assets.html?" + p.toString();
    };

    // Table: Value (with YoY) + Qty (clickable)
    $("ytdBody").innerHTML = ["RF","SAM","ALL"].map(key=>{
      const label = key==="RF" ? "FIR + RAM" : (key==="SAM" ? "SAM" : "OVERALL");
      return `<tr>
        <td>${label}</td>
        ${yrs.map((y,i)=>{
          const prev = yrs[i+1];
          const valHTML = `${moneyMil(rows[key][y].v)}${prev ? `<div class="ytd-yoy">${yoy(rows[key][y].v, rows[key][prev].v)}</div>` : ""}`;
          const sep = i===0 ? "" : ' class="ytd-sep"';
          const href = ytdUrl(key==='RF'?'RF':key==='SAM'?'SAM':'ALL', y);
          return `
            <td ${sep}>${valHTML}</td>
            <td><a href="${href}">${rows[key][y].q}</a></td>
          `;
        }).join("")}
      </tr>`;
    }).join("");

    // Bars RF/SAM/ALL per year â€” each bar clickable
    const max = Math.max(...yrs.flatMap(y => [rows.RF[y].v, rows.SAM[y].v, rows.ALL[y].v]),1);
    $("ytdChart").innerHTML = yrs.map(y => {
      const hrefRF  = ytdUrl("RF", y);
      const hrefSAM = ytdUrl("SAM", y);
      const hrefALL = ytdUrl("ALL", y);
      const hRF  = rows.RF[y].v  / max * 200;
      const hSAM = rows.SAM[y].v / max * 200;
      const hALL = rows.ALL[y].v / max * 200;
      return `
        <div class="year-group">
          <div class="bar-set">
            <a href="${hrefRF}"  class="bar rf"  style="height:${hRF}px"  title="FIR+RAM ${y}"></a>
            <a href="${hrefSAM}" class="bar sam" style="height:${hSAM}px" title="SAM ${y}"></a>
            <a href="${hrefALL}" class="bar all" style="height:${hALL}px" title="OVERALL ${y}"></a>
          </div>
          <div>${y}</div>
        </div>
      `;
    }).join("");
  }

  /* ===================== SECTION 3 (Publication) ===================== */
  const published = assets.filter(a => String(a.Status||"").toUpperCase().trim() === "PUBLISHED");

  (function publicationRow1(){
    $("pubCount").textContent = published.length;
    $("pubValue").textContent = money(published.reduce((t,a)=> t + (+a.EstMarketPrice || 0), 0));

    const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const pubAuction = published.filter(a => normChannel(a.Channel) === "PUBLIC AUCTION");
    const withCount = pubAuction.filter(a => { const d = parseDate(a.AuctionDate); return d && d >= firstDay; }).length;
    $("withAuction").textContent = withCount;
    $("withoutAuction").textContent = pubAuction.length - withCount;

    function cstat(c){
      const l = published.filter(a => normChannel(a.Channel) === c);
      return { q:l.length, v:l.reduce((t,a)=> t + (+a.EstMarketPrice || 0), 0) };
    }
    const ca = cstat("PUBLIC AUCTION"), cp = cstat("PRIVATE TREATY"), ct = cstat("OPEN TENDER");
    $("chAuction").textContent = ca.q; $("chAuctionVal").textContent = money(ca.v);
    $("chPrivate").textContent = cp.q; $("chPrivateVal").textContent = money(cp.v);
    $("chTender").textContent  = ct.q; $("chTenderVal").textContent  = money(ct.v);
  })();

  (function renderCategoryTables(){
    const ENT = [
      {k:["RAM","FIR"], l:"FIR + RAM"},
      {k:["SAM"],       l:"SAM"},
      {k:["BANKING"],   l:"BANKING"}
    ];
    const CAT = ["COMMERCIAL","VACANT LAND","RESIDENTIAL","INDUSTRIAL","HOSPITALITY","AGRICULTURE","BUILDING","OTHERS"];
    function ncat(c){
      c = String(c||"").toUpperCase();
      if(c.includes("LAND") && c.includes("BUILDING")) return "BUILDING";
      return CAT.includes(c) ? c : "OTHERS";
    }
    $("categoryTables").innerHTML = ENT.map(e=>{
      const r = {}; CAT.forEach(c => r[c] = {q:0,v:0});
      published.filter(a => e.k.includes(normEntity(a.Entity))).forEach(a=>{
        const c = ncat(a.Category);
        r[c].q++; r[c].v += (+a.EstMarketPrice || 0);
      });
      let tq = 0, tv = 0;
      const body = CAT.map(c=>{
        tq += r[c].q; tv += r[c].v;
        return `<tr><td>${c}</td><td>${r[c].q}</td><td>${money(r[c].v)}</td></tr>`;
      }).join("");
      return `
        <div class="card">
          <h3>${e.l}</h3>
          <table class="small-table">
            <thead><tr><th>Category</th><th>Qty</th><th>Est MV</th></tr></thead>
            <tbody>${body}</tbody>
            <tfoot><tr><td>TOTAL</td><td>${tq}</td><td>${money(tv)}</td></tr></tfoot>
          </table>
        </div>
      `;
    }).join("");
  })();

  function categoryGroup(raw){
    const s = String(raw||"").toUpperCase().trim();
    if (s === "AGRICULTURE" || s === "VACANT LAND") return "LAND";
    if (s === "COMMERCIAL" || s === "INDUSTRIAL" || s === "LAND & BUILDING" || s === "LAND AND BUILDING") return "COMMERCIAL";
    if (s === "HOSPITALITY") return "HOSPITALITY";
    if (s === "RESIDENTIAL") return "RESIDENTIAL";
    return "OTHERS";
  }

  function renderHBar(el, countMap, valueMap, facet){
    const totalCount = Object.values(countMap).reduce((a,b)=>a+b,0) || 1;
    const totalValue = Object.values(valueMap).reduce((a,b)=>a+b,0) || 1;

    const entries = Object.keys(countMap).map(k => ({ key:k, c:countMap[k]||0, v:valueMap[k]||0 }))
      .sort((a,b)=> (hbarBasis === 'val' ? (b.v - a.v) : (b.c - a.c)));

    el.innerHTML = entries.map(({key, c, v})=>{
      const pctCount = Math.round(c / totalCount * 100);
      const pctValue = Math.round(v / totalValue * 100);
      const barPct = hbarBasis === 'val' ? pctValue : pctCount;
      const params = new URLSearchParams({ status:"PUBLISHED", facet, value:key, view:"pub" });
      const href = "assets.html?" + params.toString();
      return `
        <a class="hbar-row" href="${href}">
          <div class="hbar-label">${key}</div>
          <div class="hbar-track"><div class="hbar-fill" style="width:${barPct}%"></div></div>
          <div class="hbar-pct">${barPct}%</div>
          <div class="tooltip"><strong>${key}</strong><br>
            Qty: ${c} (${pctCount}%)<br>
            Value: ${money(v)} (${pctValue}%)
          </div>
        </a>
      `;
    }).join("");
  }

  let distMaps = null;
  function buildDistMaps(){
    const tenureCount = {}, tenureValue = {};
    const stateCount = {}, stateValue = {};
    const catCount = {}, catValue = {};

    published.forEach(a=>{
      const v = +a.EstMarketPrice || 0;
      const t = a.Tenure || "N/A"; tenureCount[t] = (tenureCount[t]||0) + 1; tenureValue[t] = (tenureValue[t]||0) + v;
      const g = categoryGroup(a.Category); catCount[g] = (catCount[g]||0) + 1; catValue[g] = (catValue[g]||0) + v;
      const s = a.State || "N/A"; stateCount[s] = (stateCount[s]||0) + 1; stateValue[s] = (stateValue[s]||0) + v;
    });

    const catOrder = ["LAND","COMMERCIAL","HOSPITALITY","RESIDENTIAL","OTHERS"];
    const orderedCatCount = {}, orderedCatValue = {};
    catOrder.forEach(k=>{ if(catCount[k] || catValue[k]){ orderedCatCount[k]=catCount[k]||0; orderedCatValue[k]=catValue[k]||0; }});
    Object.keys(catCount).forEach(k=>{ if(!(k in orderedCatCount)){ orderedCatCount[k]=catCount[k]; orderedCatValue[k]=catValue[k]; }});

    distMaps = { tenure:{c:tenureCount, v:tenureValue}, category:{c:orderedCatCount, v:orderedCatValue}, state:{c:stateCount, v:stateValue} };
  }
  function renderAllHbars(){
    if(!distMaps) buildDistMaps();
    renderHBar($("tenureChart"),   distMaps.tenure.c,   distMaps.tenure.v,   "tenure");
    renderHBar($("categoryChart"), distMaps.category.c, distMaps.category.v, "category_group");
    renderHBar($("stateChart"),    distMaps.state.c,    distMaps.state.v,    "state");
  }
  function setHBarBasis(basis){
    hbarBasis = basis; localStorage.setItem("psc_hbar_basis", basis);
    $("basisQty").classList.toggle("active", basis==='qty');
    $("basisVal").classList.toggle("active", basis==='val');
    renderAllHbars();
  }

  function goPublishedAll(){ location.href = "assets.html?status=PUBLISHED&view=pub"; }
  function goAuction(type){
    location.href = `assets.html?status=PUBLISHED&channel=${encodeURIComponent('PUBLIC AUCTION')}&auction=${encodeURIComponent(type)}&view=pub`;
  }
  function goChannel(c){
    location.href = `assets.html?status=PUBLISHED&channel=${encodeURIComponent(c)}&view=pub`;
  }

  /* ===== Upcoming auctions (next 30 days) ===== */
  function formatDateMY(d){
    return d.toLocaleDateString('en-MY', { day:'2-digit', month:'short', year:'numeric' });
  }
  function getUpcomingAuctions(){
    const today = new Date(); today.setHours(0,0,0,0);
    const end   = new Date(today); end.setDate(end.getDate() + 30);
    return published
      .filter(a => normChannel(a.Channel) === "PUBLIC AUCTION")
      .map(a => ({ ...a, _dt: parseDate(a.AuctionDate) }))
      .filter(a => a._dt && a._dt >= today && a._dt <= end)
      .sort((a,b) => a._dt - b._dt);
  }
  function renderUpcomingNotice(){
    const list = getUpcomingAuctions();
    const notice = $("upNotice");
    const countEl = $("upCount");
    const plural = $("upPlural");
    const nearest = $("upNearest");

    if(!notice) return;
    if(!list.length){
      notice.style.display = "none";
      return;
    }
    countEl.textContent = String(list.length);
    plural.style.display = list.length > 1 ? "inline" : "none";
    nearest.textContent = formatDateMY(list[0]._dt);
    notice.style.display = "flex";
  }
  function openUpcomingModal(){
    const modal = $("upcomingModal");
    const tbody = $("upcomingList");
    if(!modal || !tbody) return;

    const list = getUpcomingAuctions();
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="4">No auctions within the next 30 days.</td></tr>`;
    }else{
      tbody.innerHTML = list.map(a=>{
        const title = a.PropertyAddress || a.CustomerName || a.AssetName || "Asset";
        return `
          <tr>
            <td>${formatDateMY(a._dt)}</td>
            <td>${title}</td>
            <td>${a.State || "â€”"}</td>
            <td style="text-align:right">${money(+a.EstMarketPrice || 0)}</td>
          </tr>`;
      }).join("");
    }
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");
  }
  function closeUpcomingModal(){
    const modal = $("upcomingModal");
    if(!modal) return;
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
  }

  /* ===================== SECTION 4 (Referral) ===================== */
  (function initRefDropdown(){
    const years = [...new Set(assets.map(a => yearOf(a.SoldDate)).filter(Boolean))].sort((a,b)=> b-a);
    const fallback = years.length ? years : [new Date().getFullYear()];
    fallback.forEach(y => $("refYear").add(new Option(y, y)));
    $("refYear").value = fallback[0];
  })();

  function normPayStatus(s){
    s = String(s||"").trim().toUpperCase();
    if(!s) return "UNPAID";
    if(s.includes("NO REFERRAL FEE")) return "NO REFERRAL FEE";
    if(s.includes("PAID")) return "PAID";
    if(s.includes("PART")) return "PARTIAL";
    return s;
  }

  function tooltipHTML(list){
    if (!list || !list.length) return "No details";
    const top = list.slice(0, 30);
    return top.map(d => {
      const who = [d.customer, d.state].filter(Boolean).join(" (") + (d.state ? ")" : "");
      const amt = money(d.amount || 0);
      return `${who} â€“ ${amt}`;
    }).join("<br>");
  }

  function renderRefBars(containerEl, map, details = {}){
    const year = +$("refYear").value;
    const entParam = $("refEntity").value;
    const total = Object.values(map).reduce((a,b)=>a+b,0) || 1;
    containerEl.innerHTML = Object.entries(map).map(([k,v])=>{
      const pct = Math.round(v/total*100);
      const lines = details[k] || [];
      const tip   = tooltipHTML(lines);
      const href = assetsHref({
        status: "SOLD",
        year: String(year),
        referred: "1",
        ...(entParam ? {entity:entParam} : {}),
        payment: normPayStatus(k)
      });
      return `
        <a class="ref-row" href="${href}">
          <div class="hbar-label">${k}</div>
          <div class="ref-track"><div class="ref-fill" style="width:${pct}%"></div></div>
          <div class="ref-pct">${pct}%</div>
          <div class="tooltip"><strong>${k}</strong><br>${tip}</div>
        </a>`;
    }).join("");
  }

  function renderTop5AgentsByQty(referred){
    const map = {};
    referred.forEach(a=>{
      const k = a.SuccessfulAgent || "N/A";
      const v = +a.SalePrice || 0;
      if(!map[k]) map[k] = {qty:0, val:0};
      map[k].qty += 1; map[k].val += v;
    });
    const top = Object.entries(map)
      .map(([agent, o]) => ({agent, qty:o.qty, val:o.val}))
      .sort((a,b)=> b.qty - a.qty || b.val - a.val || a.agent.localeCompare(b.agent))
      .slice(0,5);

    $("top5Count").textContent = top.length;

    const year = +$("refYear").value;
    const entParam = $("refEntity").value;

    $("top5Body").innerHTML = top.length ? top.map(r => {
      const href = assetsHref({
        status:"SOLD",
        year:String(year),
        referred:"1",
        agent:r.agent,
        ...(entParam ? {entity:entParam} : {})
      });
      return `
        <tr class="clickable" onclick="location.href='${href}'">
          <td class="agent">${r.agent}</td>
          <td class="qty">${r.qty}</td>
          <td class="val" style="text-align:right">${money(r.val)}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="3">No agents found.</td></tr>`;
  }

  function buildAgentDetailsMap(list){
    const map = {};
    list.forEach(a=>{
      const k = a.SuccessfulAgent || "N/A";
      if(!map[k]) map[k] = [];
      map[k].push({
        customer: a.CustomerName || "N/A",
        state: a.State || "N/A",
        value: +a.SalePrice || 0
      });
    });
    Object.values(map).forEach(arr=> arr.sort((x,y)=> y.value - x.value));
    return map;
  }

  function renderReferral(){
    const year = +$("refYear").value;
    const entParam = $("refEntity").value;
    const entSet = entParam ? new Set(entParam.split(",").map(x=>x.trim().toUpperCase())) : null;

    const sold = assets.filter(isSold);
    const yearSold = sold.filter(a => yearOf(a.SoldDate) === year);
    const entitySold = entSet ? yearSold.filter(a => entSet.has(normEntity(a.Entity))) : yearSold;

    const referred = entitySold.filter(eligibleReferral);

    const totalFee = referred.reduce((t,a)=> t + feeOf(a), 0);
    const countRef = referred.length;
    const avgPct = countRef ? (referred.reduce((t,a)=> t + rateToPercent(a.ReferralFeeRatePct), 0) / countRef) : 0;

    $("refTotalFees").textContent = money(totalFee);
    $("refTotalFeesNote").textContent = `${year}${entParam ? " â€¢ " + entParam : ""}`;
    $("refTotalFees").onclick = () => {
      location.href = assetsHref({ status:"SOLD", year:String(year), referred:"1", ...(entParam?{entity:entParam}:{}) });
    };

    $("refAssetsCount").textContent = countRef;
    $("refAssetsNote").textContent  = `${Math.round(countRef / Math.max(entitySold.length,1) * 100)}% of sold`;
    $("refAssetsCount").onclick = () => {
      location.href = assetsHref({ status:"SOLD", year:String(year), referred:"1", ...(entParam?{entity:entParam}:{}) });
    };

    $("refAvgPct").textContent = (Number(avgPct)||0).toFixed(2) + "%";
    $("refAvgPct").onclick = () => {
      location.href = assetsHref({ status:"SOLD", year:String(year), referred:"1", ...(entParam?{entity:entParam}:{}) });
    };

    // Payment Status Distribution (clickable)
    const psMap = {};      // counts
    const psDetails = {};  // status -> [{customer,state,amount}]
    referred.forEach(a=>{
      const status = normPayStatus(a.PaymentStatus);
      psMap[status] = (psMap[status]||0) + 1;
      const fee = feeOf(a);
      if(!psDetails[status]) psDetails[status] = [];
      psDetails[status].push({
        customer: a.CustomerName || a.BuyerName || "â€”",
        state: a.State || "",
        amount: fee
      });
    });
    renderRefBars($("refStatusBars"), psMap, psDetails);

    // Top agents by referral fees (bars clickable)
    const agFeeMap = {};
    const detailsByAgent = buildAgentDetailsMap(referred);
    referred.forEach(a=>{
      const fee = feeOf(a);
      const k = a.SuccessfulAgent || "N/A";
      agFeeMap[k] = (agFeeMap[k]||0) + fee;
    });
    const topArr = Object.entries(agFeeMap).sort((a,b)=> b[1]-a[1]).slice(0,6);
    const tot = topArr.reduce((t,[,v])=>t+v,0) || 1;
    $("refTopAgents").innerHTML = topArr.map(([k,v])=>{
      const pctv = Math.round(v/tot*100);
      const lines = (detailsByAgent[k]||[]).slice(0,8).map(d => `${d.customer} (${d.state}) â€“ ${money(d.value)}`).join("<br>");
      const href = assetsHref({ status:"SOLD", year:String(year), referred:"1", agent:k, ...(entParam?{entity:entParam}:{}) });
      return `
        <a class="ref-row" href="${href}" title="${k}">
          <div class="hbar-label">${k}</div>
          <div class="ref-track"><div class="ref-fill" style="width:${pctv}%"></div></div>
          <div class="ref-pct">${pctv}%</div>
          <div class="tooltip"><strong>${k}</strong><br>${lines || "No details"}</div>
        </a>`;
    }).join("");

    // RIGHT: Top 5 agents by most assets sold (qty)
    renderTop5AgentsByQty(referred);
  }

  /* ========== Top Referring Agent Card (by qty) ========== */
  let topAgentYear = null;
  function buildTopYearButtons(){
    const years = [...new Set(
      assets.filter(isSold).map(a => yearOf(a.SoldDate)).filter(Boolean)
    )].sort((a,b)=> b-a);
    const list = years.length ? years.slice(0,3) : [new Date().getFullYear()];
    if(topAgentYear === null) topAgentYear = list[0];

    $("topYearBtns").innerHTML = list.map(y =>
      `<button class="${y===topAgentYear?'active':''}" onclick="setTopAgentYear(${y})">${y}</button>`
    ).join("");
  }
  function setTopAgentYear(y){
    topAgentYear = y;
    buildTopYearButtons();
    renderTopAgentCard();
  }
  function renderTopAgentCard(){
    const list = assets.filter(a => yearOf(a.SoldDate) === topAgentYear && eligibleReferral(a));
    if(!list.length){
      $("topAgentName").textContent="â€“";
      $("topAgentQty").textContent="0";
      $("topAgentTotalVal").textContent="";
      return;
    }
    const countMap = {}, valMap = {};
    list.forEach(a=>{
      const k = a.SuccessfulAgent || "N/A";
      countMap[k] = (countMap[k]||0) + 1;
      valMap[k] = (valMap[k]||0) + (+a.SalePrice||0);
    });
    const top = Object.keys(countMap)
      .map(k=>({agent:k, qty:countMap[k], val:valMap[k]}))
      .sort((a,b)=> b.qty - a.qty || b.val - a.val || a.agent.localeCompare(b.agent))[0];

    $("topAgentName").textContent = top.agent;
    $("topAgentQty").textContent = top.qty;
    $("topAgentTotalVal").textContent = `Total value: ${money(top.val)}`;

    const href = assetsHref({ status:"SOLD", year: String(topAgentYear), agent: top.agent, referred:"1" });
    $("topAgentName").onclick = () => location.href = href;
    $("topAgentQty").onclick = () => location.href = href;
  }

  /* ===== Referral Summary (YoY + YTD) ===== */
  const REF_SAVINGS_RATE = 0.0125; // 1.25%
  function isIntroduced(a){
    return rateToPercent(a.ReferralFeeRatePct) > 0 && (+a.SalePrice || 0) > 0 && !isNoRefFeeStatus(a.PaymentStatus);
  }
  function isNoAgent(a){
    return (+a.SalePrice || 0) > 0 && rateToPercent(a.ReferralFeeRatePct) <= 0;
  }
  function filterByEntity(list, entParam){
    if(!entParam) return list;
    const entSet = new Set(entParam.split(",").map(x=>x.trim().toUpperCase()));
    return list.filter(a => entSet.has(normEntity(a.Entity)));
  }
  function ytdSieve(list, year, cutoffMonth){
    return list.filter(a=>{
      if(!isSold(a)) return false;
      const d = parseDate(a.SoldDate);
      if(!d) return false;
      return d.getFullYear()===year && (d.getMonth()+1)<=cutoffMonth;
    });
  }
  function fillRefYtdControls(){
    const msel = $("refCutoffMonth");
    if(msel && !msel.options.length){
      months.forEach((m,i)=> msel.add(new Option(m, i+1)));
      msel.value = String(new Date().getMonth()+1);
    }
    const yearsSold = [...new Set(assets.filter(isSold).map(a=>yearOf(a.SoldDate)).filter(Boolean))].sort((a,b)=>b-a);
    const ysel = $("refBaseYear");
    if(ysel && !ysel.options.length){
      const fallback = yearsSold.length ? yearsSold : [new Date().getFullYear()];
      fallback.forEach(y=> ysel.add(new Option(y,y)));
      ysel.value = fallback[0];
    }
  }

  function computeYearCard(year, cutoffMonth, entParam){
    const soldAll = assets.filter(isSold);
    const ytdList = ytdSieve(soldAll, year, +cutoffMonth);
    const scoped  = filterByEntity(ytdList, entParam);

    const introduced = scoped.filter(isIntroduced);
    const introQty   = introduced.length;
    const introducedValue = sumSale(introduced);
    const feeTotal   = introduced.reduce((t,a)=> t + feeOf(a), 0);
    const pctOfIntroduced = introducedValue > 0 ? (feeTotal/introducedValue*100) : 0;
    const uniqueAgentCount = new Set(introduced.map(a => (a.SuccessfulAgent || "N/A").trim().toUpperCase())).size;

    const noAgent    = scoped.filter(isNoAgent);
    const directVal  = sumSale(noAgent);
    const directQty  = noAgent.length;
    const saving     = directVal * REF_SAVINGS_RATE;

    const feeByAgent = {};
    const qtyByAgent = {};
    introduced.forEach(a=>{
      const k = a.SuccessfulAgent || "N/A";
      feeByAgent[k] = (feeByAgent[k]||0) + feeOf(a);
      qtyByAgent[k] = (qtyByAgent[k]||0) + 1;
    });
    let topAgentName="â€“", topAgentFee=0, topAgentQty=0;
    if(Object.keys(feeByAgent).length){
      const top = Object.entries(feeByAgent).sort((a,b)=> b[1]-a[1])[0];
      topAgentName = top[0];
      topAgentFee  = top[1];
      topAgentQty  = qtyByAgent[top[0]] || 0;
    }

    return {
      year, introducedValue, introQty, feeTotal, pctOfIntroduced,
      directVal, directQty, saving, topAgentName, topAgentFee, topAgentQty, uniqueAgentCount
    };
  }

  function refCardHTML(p){
    const {
      year, introducedValue, introQty, feeTotal, pctOfIntroduced,
      directVal, directQty, saving,
      topAgentName, topAgentFee, topAgentQty, uniqueAgentCount
    } = p;

    const cutoff = String($("refCutoffMonth").value || (new Date().getMonth()+1));
    const entParam = $("refEntity").value;

    // Build URLs
    const common = { status:"SOLD", year:String(year), month:cutoff };
    const hrefReferred = "assets.html?" + new URLSearchParams({ ...common, referred:"1", ...(entParam?{entity:entParam}:{}) }).toString();
    const hrefDirect   = "assets.html?" + new URLSearchParams({ ...common, direct:"1",   ...(entParam?{entity:entParam}:{}) }).toString();

    return `
      <div class="ref-summ">
        <div class="badge-year">YTD ${months[(+cutoff)-1]} ${year}</div>

        <!-- Introduced (with referral fee) -->
        <a href="${hrefReferred}" class="block" title="Open introduced (with referral) list">
          <div class="primary">${moneyMil(introducedValue)}</div>
          <div class="muted">
            Assets with referral fee: ${introQty}<br>
            Agents involved: ${uniqueAgentCount}<br>
            Referral fee paid (YTD): <span class="accent">${money(feeTotal)}</span><br>
            <span class="accent">${pctOfIntroduced.toFixed(2)}%</span>
          </div>
        </a>

        <hr>

        <!-- Direct / No Agent -->
        <a href="${hrefDirect}" class="block" title="Open direct / no-agent list">
          <div class="primary">${moneyMil(directVal)}</div>
          <div class="muted">
            No Agent / Direct Buyer: ${directQty}<br>
            with <span class="accent">${money(saving)}</span><br>
            Estimated Cost Saving @1.25%
          </div>
        </a>

        <div class="note" style="margin-top:6px">
          <strong>Top Agent:</strong> ${topAgentName}<br>
          Fee paid: ${money(topAgentFee)} â€¢ Qty: ${topAgentQty}
        </div>
      </div>
    `;
  }

  function renderRefSummaryCards(){
    fillRefYtdControls();
    const cutoff = +($("refCutoffMonth").value || (new Date().getMonth()+1));
    const baseY  = +($("refBaseYear").value || new Date().getFullYear());
    const entParam = $("refEntity").value;

    const years = [baseY, baseY-1, baseY-2];
    $("refSummaryRow").innerHTML = years
      .map(y => refCardHTML(computeYearCard(y, cutoff, entParam)))
      .join("") || `<div class="ref-summ" style="grid-column:1/-1">No data to summarize.</div>`;
  }

  /* ============== INIT ============== */
  // Section 2
  renderYTD();

  // Section 3 bars
  setHBarBasis(hbarBasis);
  renderAllHbars();

  // Upcoming auctions (notice + modal wiring)
  renderUpcomingNotice();
  $("upDetails")?.addEventListener("click", (e)=>{ e.preventDefault(); openUpcomingModal(); });
  $("upClose")?.addEventListener("click", closeUpcomingModal);
  $("upcomingModal")?.addEventListener("click", (e)=>{ if(e.target.id === "upcomingModal") closeUpcomingModal(); });

  // Section 4
  renderReferral();

  // Top agent card
  buildTopYearButtons();
  renderTopAgentCard();

  // Summary controls
  fillRefYtdControls();
  renderRefSummaryCards();
</script>
</body>
</html>
